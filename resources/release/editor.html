<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>margaui editor</title>
  <style id="page-styles"></style>
  <style id="layout-styles">
    /* Page layout — unlayered so it beats the Tailwind reset */
    * { box-sizing: border-box; }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #ed-nav {
      padding-inline: 1.5rem;
      border-bottom: 1px solid var(--color-base-300);
      gap: 1rem;
    }
    #ed-nav .ed-title {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.025em;
    }
    #ed-body {
      display: flex;
      flex: 1;
      min-height: 0;
    }
    /* Left panel: editor */
    #ed-left {
      width: 50%;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--color-base-300);
    }
    #ed-toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--color-base-300);
      background: var(--color-base-100);
      flex-wrap: wrap;
    }
    #ed-toolbar label {
      font-size: 0.8125rem;
      font-weight: 600;
    }
    #html-input {
      flex: 1;
      resize: none;
      border: none;
      outline: none;
      padding: 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.8125rem;
      line-height: 1.5;
      background: var(--color-base-100);
      color: inherit;
      tab-size: 2;
    }
    /* Right panel: preview + css */
    #ed-right {
      width: 50%;
      display: flex;
      flex-direction: column;
    }
    #ed-tabs {
      display: flex;
      border-bottom: 1px solid var(--color-base-300);
      background: var(--color-base-100);
    }
    .ed-tab {
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: none;
      color: inherit;
      border-bottom: 2px solid transparent;
      opacity: 0.5;
    }
    .ed-tab[aria-selected="true"] {
      opacity: 1;
      border-bottom-color: currentColor;
    }
    #ed-stats {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-right: 0.75rem;
      font-size: 0.75rem;
      opacity: 0.5;
    }
    #ed-panel-preview {
      flex: 1;
      overflow: auto;
      background: var(--color-base-100);
    }
    #ed-panel-css {
      flex: 1;
      overflow: auto;
      background: var(--color-neutral);
      color: var(--color-neutral-content);
      padding: 1rem;
    }
    .ed-hidden { display: none !important; }
    #ed-panel-css pre { margin: 0; }
    #ed-panel-css code {
      font-size: 0.75rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      white-space: pre;
    }
    #preview-frame {
      width: 100%;
      height: 100%;
      display: flex;
      flex-wrap: wrap;
      align-items: start;
      gap: 1rem;
      padding: 2rem;
    }
  </style>
</head>
<body style="visibility: hidden" data-theme="light">
  <div id="app">
    <nav id="ed-nav" class="navbar bg-base-100">
      <span class="ed-title">margaui editor</span>
      <select id="example-select" class="select select-sm select-bordered"></select>
      <select id="theme-select" class="select select-sm select-bordered"></select>
    </nav>
    <div id="ed-body">
      <div id="ed-left">
        <textarea id="html-input" spellcheck="false" placeholder="Write HTML here..."></textarea>
      </div>
      <div id="ed-right">
        <div id="ed-tabs">
          <button class="ed-tab" aria-selected="true" data-panel="preview">Preview</button>
          <button class="ed-tab" aria-selected="false" data-panel="css">CSS</button>
          <div id="ed-stats">
            <span id="stat-size">-</span>
            <span id="stat-time">-</span>
          </div>
        </div>
        <div id="ed-panel-preview">
          <div id="preview-frame"></div>
        </div>
        <div id="ed-panel-css" class="ed-hidden">
          <pre><code id="css-output"></code></pre>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { getCompiler } from "./margaui.min.js";

    // ── Built-in examples ──────────────────────────────────────────
    const EXAMPLES = {
      "Buttons": `<button class="btn btn-primary">Primary</button>
<button class="btn btn-secondary">Secondary</button>
<button class="btn btn-accent">Accent</button>
<button class="btn btn-outline">Outline</button>
<button class="btn btn-ghost">Ghost</button>
<button class="btn btn-link">Link</button>
<button class="btn btn-lg">Large</button>
<button class="btn btn-sm">Small</button>
<button class="btn btn-xs">Tiny</button>`,

      "Card": `<div class="card bg-base-100 w-96 shadow-xl">
  <div class="card-body">
    <h2 class="card-title">Card Title</h2>
    <p>A card component with a title, description text, and an action button.</p>
    <div class="card-actions justify-end">
      <button class="btn btn-primary">Buy Now</button>
    </div>
  </div>
</div>`,

      "Hero": `<div class="hero min-h-96 bg-base-200 rounded-box">
  <div class="hero-content text-center">
    <div class="max-w-md">
      <h1 class="text-5xl font-bold">Hello there</h1>
      <p class="py-6">Provident cupiditate voluptatem et in. Quaerat fugiat ut assumenda excepturi exercitationem quasi.</p>
      <button class="btn btn-primary">Get Started</button>
    </div>
  </div>
</div>`,

      "Chat": `<div class="chat chat-start">
  <div class="chat-bubble">Hey! How's it going?</div>
</div>
<div class="chat chat-start">
  <div class="chat-bubble">I just tried margaui, it's awesome!</div>
</div>
<div class="chat chat-end">
  <div class="chat-bubble chat-bubble-primary">Thanks! Glad you like it.</div>
</div>
<div class="chat chat-end">
  <div class="chat-bubble chat-bubble-primary">Let me know if you need anything.</div>
</div>`,

      "Table": `<div class="overflow-x-auto">
  <table class="table table-zebra">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Role</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td>Alice Johnson</td>
        <td>Developer</td>
        <td><span class="badge badge-success">Active</span></td>
      </tr>
      <tr>
        <td>2</td>
        <td>Bob Smith</td>
        <td>Designer</td>
        <td><span class="badge badge-warning">Away</span></td>
      </tr>
      <tr>
        <td>3</td>
        <td>Carol White</td>
        <td>Manager</td>
        <td><span class="badge badge-success">Active</span></td>
      </tr>
    </tbody>
  </table>
</div>`,

      "Modal": `<button class="btn btn-primary" onclick="document.getElementById('demo-modal').showModal()">
  Open Modal
</button>

<dialog id="demo-modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">Hello!</h3>
    <p class="py-4">This modal was opened with the native &lt;dialog&gt; element.</p>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>`,

      "Alerts": `<div class="alert alert-info">
  <span>Info: This is an informational message.</span>
</div>
<div class="alert alert-success">
  <span>Success: Operation completed successfully!</span>
</div>
<div class="alert alert-warning">
  <span>Warning: Please review before continuing.</span>
</div>
<div class="alert alert-error">
  <span>Error: Something went wrong.</span>
</div>`,

      "Navbar": `<div class="navbar bg-base-100 shadow-sm rounded-box">
  <div class="navbar-start">
    <a class="btn btn-ghost text-xl">margaui</a>
  </div>
  <div class="navbar-center">
    <a class="btn btn-ghost btn-sm">Home</a>
    <a class="btn btn-ghost btn-sm">About</a>
    <a class="btn btn-ghost btn-sm">Contact</a>
  </div>
  <div class="navbar-end">
    <button class="btn btn-primary btn-sm">Sign In</button>
  </div>
</div>`,
    };

    const THEMES = [
      "light", "dark", "abyss", "acid", "aqua", "autumn", "black", "bumblebee",
      "business", "caramellatte", "cmyk", "coffee", "corporate", "cupcake",
      "cyberpunk", "dim", "dracula", "emerald", "fantasy", "forest", "garden",
      "halloween", "lemonade", "lofi", "luxury", "night", "nord", "pastel",
      "retro", "silk", "sunset", "synthwave", "valentine", "winter", "wireframe",
    ];

    // ── Init compiler ──────────────────────────────────────────────
    const compiler = await getCompiler();

    // Compile page shell classes
    const PAGE_CLASSES = [
      "navbar", "bg-base-100",
      "select", "select-sm", "select-bordered",
    ];
    document.getElementById("page-styles").textContent = compiler.build(PAGE_CLASSES);
    document.body.style.visibility = "visible";

    // ── Theme setup ────────────────────────────────────────────────
    function adoptableThemeCss(css) {
      return css.replace(/^([^{]*)\{/, ':root, :host, $1{');
    }

    const themeSheet = new CSSStyleSheet();
    const initialThemeCss = await fetch("./themes/light.css").then(r => r.text());
    themeSheet.replaceSync(adoptableThemeCss(initialThemeCss));
    document.adoptedStyleSheets = [...document.adoptedStyleSheets, themeSheet];

    const themeSelect = document.getElementById("theme-select");
    for (const t of THEMES) {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      if (t === "light") opt.selected = true;
      themeSelect.appendChild(opt);
    }

    themeSelect.addEventListener("change", async () => {
      const css = await fetch(`./themes/${themeSelect.value}.css`).then(r => r.text());
      themeSheet.replaceSync(adoptableThemeCss(css));
      document.body.setAttribute("data-theme", themeSelect.value);
    });

    // ── Example selector ───────────────────────────────────────────
    const exampleSelect = document.getElementById("example-select");
    const exampleNames = Object.keys(EXAMPLES);
    for (const name of exampleNames) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      exampleSelect.appendChild(opt);
    }

    exampleSelect.addEventListener("change", () => {
      htmlInput.value = EXAMPLES[exampleSelect.value];
      render();
    });

    // ── Editor ─────────────────────────────────────────────────────
    const htmlInput = document.getElementById("html-input");
    const previewFrame = document.getElementById("preview-frame");
    const cssOutput = document.getElementById("css-output");
    const statSize = document.getElementById("stat-size");
    const statTime = document.getElementById("stat-time");

    // Tab switching
    const tabs = document.querySelectorAll(".ed-tab");
    const panelPreview = document.getElementById("ed-panel-preview");
    const panelCss = document.getElementById("ed-panel-css");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.setAttribute("aria-selected", "false"));
        tab.setAttribute("aria-selected", "true");
        const panel = tab.dataset.panel;
        panelPreview.classList.toggle("ed-hidden", panel !== "preview");
        panelCss.classList.toggle("ed-hidden", panel !== "css");
      });
    });

    // Shadow DOM for preview isolation
    const shadow = previewFrame.attachShadow({ mode: "open" });
    shadow.adoptedStyleSheets = [themeSheet];

    function render() {
      const html = htmlInput.value;

      // Extract class names
      const classRegex = /class="([^"]*)"/g;
      const classes = new Set();
      let match;
      while ((match = classRegex.exec(html)) !== null) {
        for (const cls of match[1].split(/\s+/)) {
          if (cls) classes.add(cls);
        }
      }

      // Compile CSS
      let css = "";
      let buildMs = 0;
      if (classes.size > 0) {
        const t0 = performance.now();
        css = compiler.build([...classes]);
        buildMs = performance.now() - t0;
      }

      // Update preview (inside shadow DOM)
      shadow.innerHTML = `
        <style>${css}</style>
        <div style="display:flex;flex-wrap:wrap;align-items:start;gap:1rem;padding:2rem">${html}</div>
      `;

      // Update CSS tab
      cssOutput.textContent = css;

      // Update stats
      const kb = (new Blob([css]).size / 1024).toFixed(2);
      const ms = buildMs.toFixed(1);
      statSize.textContent = `${kb} KB`;
      statTime.textContent = `${ms} ms`;
    }

    // Debounced input
    let debounceTimer = null;
    htmlInput.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(render, 100);
    });

    // Handle tab key in textarea
    htmlInput.addEventListener("keydown", (e) => {
      if (e.key === "Tab") {
        e.preventDefault();
        const start = htmlInput.selectionStart;
        const end = htmlInput.selectionEnd;
        htmlInput.value = htmlInput.value.substring(0, start) + "  " + htmlInput.value.substring(end);
        htmlInput.selectionStart = htmlInput.selectionEnd = start + 2;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(render, 100);
      }
    });

    // Load first example
    htmlInput.value = EXAMPLES[exampleNames[0]];
    render();
  </script>
</body>
</html>
